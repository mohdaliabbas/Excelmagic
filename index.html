import React, { useState } from 'react';
import { Upload, Download, Plus, Trash2, FileSpreadsheet, Check } from 'lucide-react';
import * as XLSX from 'xlsx';

export default function TaskAutomationTool() {
  const [activeTab, setActiveTab] = useState('excel');
  const [excelFile, setExcelFile] = useState(null);
  const [sheets, setSheets] = useState([]);
  const [selectedSheet, setSelectedSheet] = useState('');
  const [columns, setColumns] = useState([]);
  const [selectedColumns, setSelectedColumns] = useState([]);
  const [newColumns, setNewColumns] = useState([]);
  const [processedData, setProcessedData] = useState(null);
  const [newColumnName, setNewColumnName] = useState('');
  const [showAddColumn, setShowAddColumn] = useState(false);

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const workbook = XLSX.read(event.target.result, { type: 'binary' });
        setExcelFile(workbook);
        setSheets(workbook.SheetNames);
        setSelectedSheet(workbook.SheetNames[0]);
        
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(firstSheet);
        if (data.length > 0) {
          setColumns(Object.keys(data[0]));
        }
      } catch (error) {
        alert('Error reading file. Please upload a valid Excel file.');
      }
    };
    reader.readAsBinaryString(file);
  };

  const handleSheetChange = (sheetName) => {
    setSelectedSheet(sheetName);
    const sheet = excelFile.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet);
    if (data.length > 0) {
      setColumns(Object.keys(data[0]));
    }
    setSelectedColumns([]);
  };

  const toggleColumnSelection = (col) => {
    setSelectedColumns(prev => 
      prev.includes(col) ? prev.filter(c => c !== col) : [...prev, col]
    );
  };

  const handleAddNewColumn = () => {
    if (newColumnName && newColumnName.trim()) {
      setNewColumns([...newColumns, { name: newColumnName.trim(), formula: '' }]);
      setNewColumnName('');
      setShowAddColumn(false);
    } else {
      alert('Please enter a column name');
    }
  };

  const updateColumnFormula = (index, formula) => {
    const updated = [...newColumns];
    updated[index].formula = formula;
    setNewColumns(updated);
  };

  const removeNewColumn = (index) => {
    setNewColumns(newColumns.filter((_, i) => i !== index));
  };

  const processExcel = () => {
    if (!excelFile || selectedColumns.length === 0) {
      alert('Please select at least one column to process.');
      return;
    }

    const sheet = excelFile.Sheets[selectedSheet];
    const data = XLSX.utils.sheet_to_json(sheet);

    const processedRows = data.map((row) => {
      const newRow = {};
      
      // Add selected columns
      selectedColumns.forEach(col => {
        newRow[col] = row[col];
      });

      // Add new columns with formulas
      newColumns.forEach(newCol => {
        if (newCol.formula.trim()) {
          try {
            // Simple formula evaluation (supports basic operations)
            let result = newCol.formula;
            
            // Replace column references with values
            Object.keys(row).forEach(key => {
              const regex = new RegExp(`\\{${key}\\}`, 'g');
              result = result.replace(regex, row[key] || 0);
            });
            
            // Evaluate if it's a mathematical expression
            if (/^[\d\s+\-*/().]+$/.test(result)) {
              result = eval(result);
            }
            newRow[newCol.name] = result;
          } catch (error) {
            newRow[newCol.name] = newCol.formula;
          }
        } else {
          newRow[newCol.name] = '';
        }
      });

      return newRow;
    });

    setProcessedData(processedRows);
    alert('Data processed successfully! You can now download it.');
  };

  const downloadExcel = () => {
    if (!processedData) {
      alert('Please process the data first');
      return;
    }

    const ws = XLSX.utils.json_to_sheet(processedData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Processed Data');
    XLSX.writeFile(wb, 'processed_data.xlsx');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <FileSpreadsheet size={36} />
              Daily Task Automation Tool
            </h1>
            <p className="mt-2 text-blue-100">Streamline your Excel workflows and daily tasks</p>
          </div>

          {/* Content */}
          <div className="p-6">
            <div className="space-y-6">
              {/* File Upload */}
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                <Upload className="mx-auto mb-4 text-gray-400" size={48} />
                <label className="cursor-pointer">
                  <span className="text-blue-600 font-medium hover:text-blue-700">
                    Upload Excel File
                  </span>
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                </label>
                <p className="text-sm text-gray-500 mt-2">Supports .xlsx and .xls files</p>
              </div>

              {sheets.length > 0 && (
                <>
                  {/* Sheet Selection */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Select Sheet
                    </label>
                    <select
                      value={selectedSheet}
                      onChange={(e) => handleSheetChange(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      {sheets.map(sheet => (
                        <option key={sheet} value={sheet}>{sheet}</option>
                      ))}
                    </select>
                  </div>

                  {/* Column Selection */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Select Columns to Include ({selectedColumns.length} selected)
                    </label>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                      {columns.map(col => (
                        <button
                          key={col}
                          type="button"
                          onClick={() => toggleColumnSelection(col)}
                          className={`p-3 rounded-lg border-2 transition-all flex items-center justify-between ${
                            selectedColumns.includes(col)
                              ? 'border-blue-500 bg-blue-50 text-blue-700'
                              : 'border-gray-200 hover:border-gray-300'
                          }`}
                        >
                          <span className="truncate text-sm">{col}</span>
                          {selectedColumns.includes(col) && <Check size={16} />}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* New Columns */}
                  <div>
                    <div className="flex items-center justify-between mb-3">
                      <label className="block text-sm font-medium text-gray-700">
                        Add New Columns ({newColumns.length} added)
                      </label>
                      <button
                        type="button"
                        onClick={() => setShowAddColumn(!showAddColumn)}
                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                      >
                        <Plus size={16} />
                        Add Column
                      </button>
                    </div>

                    {showAddColumn && (
                      <div className="mb-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          New Column Name
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={newColumnName}
                            onChange={(e) => setNewColumnName(e.target.value)}
                            placeholder="Enter column name"
                            className="flex-1 p-2 border border-gray-300 rounded-lg"
                            onKeyPress={(e) => e.key === 'Enter' && handleAddNewColumn()}
                          />
                          <button
                            type="button"
                            onClick={handleAddNewColumn}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                          >
                            Create
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              setShowAddColumn(false);
                              setNewColumnName('');
                            }}
                            className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}

                    {newColumns.length > 0 && (
                      <div className="space-y-3">
                        {newColumns.map((col, idx) => (
                          <div key={idx} className="flex gap-3 items-start p-4 bg-gray-50 rounded-lg">
                            <div className="flex-1">
                              <div className="font-medium text-sm text-gray-700 mb-2">
                                {col.name}
                              </div>
                              <input
                                type="text"
                                placeholder="Formula (e.g., {Price} * 1.1 or use text)"
                                value={col.formula}
                                onChange={(e) => updateColumnFormula(idx, e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded text-sm"
                              />
                              <p className="text-xs text-gray-500 mt-1">
                                Use {'{ColumnName}'} to reference existing columns
                              </p>
                            </div>
                            <button
                              type="button"
                              onClick={() => removeNewColumn(idx)}
                              className="p-2 text-red-600 hover:bg-red-50 rounded"
                            >
                              <Trash2 size={16} />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Process Button */}
                  <div className="flex gap-4">
                    <button
                      type="button"
                      onClick={processExcel}
                      disabled={selectedColumns.length === 0}
                      className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Process Data
                    </button>
                    
                    {processedData && (
                      <button
                        type="button"
                        onClick={downloadExcel}
                        className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
                      >
                        <Download size={20} />
                        Download Excel
                      </button>
                    )}
                  </div>

                  {/* Preview */}
                  {processedData && (
                    <div className="mt-6">
                      <h3 className="font-medium text-gray-700 mb-3">
                        Preview ({processedData.length} rows)
                      </h3>
                      <div className="overflow-x-auto border rounded-lg">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50">
                            <tr>
                              {Object.keys(processedData[0]).map(key => (
                                <th key={key} className="px-4 py-2 text-left font-medium text-gray-700 border-b">
                                  {key}
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {processedData.slice(0, 10).map((row, idx) => (
                              <tr key={idx} className="border-t hover:bg-gray-50">
                                {Object.values(row).map((val, i) => (
                                  <td key={i} className="px-4 py-2 border-b">
                                    {val}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      {processedData.length > 10 && (
                        <p className="text-sm text-gray-500 mt-2 text-center">
                          Showing first 10 rows of {processedData.length}
                        </p>
                      )}
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
