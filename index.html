<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Task Automation Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6">
    <h1 class="text-3xl font-bold mb-6">
      ðŸ“Š Daily Task Automation Tool
    </h1>

    <!-- Upload -->
    <div class="border-2 border-dashed border-gray-300 p-6 rounded-lg text-center mb-6">
      <input type="file" id="fileInput" accept=".xlsx,.xls" />
    </div>

    <!-- Sheet Selection -->
    <div id="sheetSection" class="hidden mb-4">
      <select id="sheetSelect" class="w-full p-2 border rounded"></select>
    </div>

    <!-- Column Selection -->
    <div id="columnsSection" class="hidden mb-6">
      <h2 class="font-semibold mb-2">Select Columns</h2>
      <div id="columnsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </div>

    <!-- Add Column -->
    <div id="newColumnSection" class="hidden mb-6">
      <input id="newColumnName" placeholder="New column name"
        class="border p-2 rounded mr-2" />
      <button onclick="addNewColumn()"
        class="bg-green-600 text-white px-4 py-2 rounded">
        Add Column
      </button>
      <div id="newColumnsList" class="mt-4"></div>
    </div>

    <button onclick="processExcel()"
      class="bg-blue-600 text-white px-6 py-2 rounded">
      Process Data
    </button>

    <button id="downloadBtn"
      onclick="downloadExcel()"
      class="bg-green-600 text-white px-6 py-2 rounded ml-4 hidden">
      Download Excel
    </button>
  </div>

<script>
let workbook = null
let selectedSheet = ''
let selectedColumns = []
let newColumns = []
let processedData = []

document.getElementById('fileInput').addEventListener('change', handleFile)

function handleFile(e) {
  const file = e.target.files[0]
  const reader = new FileReader()

  reader.onload = function(event) {
    workbook = XLSX.read(event.target.result, { type: 'binary' })
    const sheets = workbook.SheetNames

    const sheetSelect = document.getElementById('sheetSelect')
    sheetSelect.innerHTML = ''

    sheets.forEach(name => {
      const option = document.createElement('option')
      option.value = name
      option.textContent = name
      sheetSelect.appendChild(option)
    })

    selectedSheet = sheets[0]
    loadColumns()

    document.getElementById('sheetSection').classList.remove('hidden')
    document.getElementById('columnsSection').classList.remove('hidden')
    document.getElementById('newColumnSection').classList.remove('hidden')
  }

  reader.readAsBinaryString(file)
}

document.getElementById('sheetSelect').addEventListener('change', function(e) {
  selectedSheet = e.target.value
  loadColumns()
})

function loadColumns() {
  const sheet = workbook.Sheets[selectedSheet]
  const data = XLSX.utils.sheet_to_json(sheet)

  if (!data.length) return

  const columns = Object.keys(data[0])
  const container = document.getElementById('columnsContainer')
  container.innerHTML = ''
  selectedColumns = []

  columns.forEach(col => {
    const btn = document.createElement('button')
    btn.textContent = col
    btn.className = "p-2 border rounded"
    btn.onclick = () => toggleColumn(col, btn)
    container.appendChild(btn)
  })
}

function toggleColumn(col, btn) {
  if (selectedColumns.includes(col)) {
    selectedColumns = selectedColumns.filter(c => c !== col)
    btn.classList.remove('bg-blue-100')
  } else {
    selectedColumns.push(col)
    btn.classList.add('bg-blue-100')
  }
}

function addNewColumn() {
  const name = document.getElementById('newColumnName').value
  if (!name) return

  newColumns.push({ name, formula: '' })

  const div = document.createElement('div')
  div.innerHTML = `
    <div class="flex gap-2 mb-2">
      <input placeholder="Formula e.g {Price} * 1.1"
        class="border p-2 rounded flex-1"
        oninput="updateFormula(${newColumns.length-1}, this.value)" />
    </div>
  `
  document.getElementById('newColumnsList').appendChild(div)
  document.getElementById('newColumnName').value = ''
}

function updateFormula(index, value) {
  newColumns[index].formula = value
}

function safeEvaluate(expression) {
  try {
    return Function('"use strict"; return (' + expression + ")")()
  } catch {
    return expression
  }
}

function processExcel() {
  const sheet = workbook.Sheets[selectedSheet]
  const data = XLSX.utils.sheet_to_json(sheet)

  processedData = data.map(row => {
    let newRow = {}

    selectedColumns.forEach(col => {
      newRow[col] = row[col]
    })

    newColumns.forEach(col => {
      let result = col.formula
      Object.keys(row).forEach(key => {
        const regex = new RegExp(`\\{${key}\\}`, 'g')
        result = result.replace(regex, row[key] ?? 0)
      })

      if (/^[\d\s+\-*/().]+$/.test(result)) {
        result = safeEvaluate(result)
      }

      newRow[col.name] = result
    })

    return newRow
  })

  document.getElementById('downloadBtn').classList.remove('hidden')
  alert("Processing complete!")
}

function downloadExcel() {
  const ws = XLSX.utils.json_to_sheet(processedData)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, "Processed Data")
  XLSX.writeFile(wb, "processed_data.xlsx")
}
</script>

</body>
</html>
